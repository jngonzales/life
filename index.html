<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlowState: Mindful Productivity Hub</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <style>
    /* 
      IMPROVEMENT: Added CSS variables for animations and improved color consistency.
      IMPROVEMENT: Added keyframe animations for fade-in and slide-up effects.
    */
    :root {
      --bg: #0a0e13;
      --bg-secondary: #1a1f29;
      --fg: #e2e8f0;
      --muted: #94a3b8;
      --card: #151b26;
      --card-hover: #1e2533;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-2: #8b5cf6;
      --green: #10b981;
      --red: #ef4444;
      --yellow: #f59e0b;
      --shadow: 0 4px 15px rgba(0,0,0,0.2);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.3);
      --radius: 16px;
      --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-medium: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .light {
      --bg: #f8fafc;
      --bg-secondary: #f1f5f9;
      --fg: #1e293b;
      --muted: #64748b;
      --card: #ffffff;
      --card-hover: #f1f5f9;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --shadow: 0 4px 15px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-secondary) 100%);
      color: var(--fg);
      min-height: 100vh;
      transition: var(--transition-medium);
    }
    
    /* NEW: Loader for initial auth check */
    #loader {
        display: flex;
        align-items: center;
        justify-content: center;
        position: fixed;
        inset: 0;
        font-size: 1.2rem;
        color: var(--muted);
        transition: opacity 0.3s;
        z-index: 2000;
        background: var(--bg);
    }
    #loader.hidden {
        opacity: 0;
        pointer-events: none;
    }

    /* Icons */
    .icon {
      font-family: 'Material Icons Round';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      vertical-align: middle;
      margin-right: 8px;
    }

    /* Header */
    header { 
      position: sticky; 
      top: 0; 
      z-index: 100;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      background: color-mix(in oklab, var(--bg) 80%, transparent);
      border-bottom: 1px solid color-mix(in oklab, var(--accent) 15%, transparent);
      display: none; /* Hide header by default */
    }
    
    body.logged-in header {
      display: block; /* Show header only when logged in */
    }

    .wrap { 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 24px;
    }
    
    main.wrap {
      animation: fadeIn 0.5s ease-in-out;
    }

    h1 { 
      font-size: clamp(24px, 4vw, 32px);
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .row { 
      display: flex; 
      gap: 16px; 
      align-items: center; 
      flex-wrap: wrap;
    }

    .spacer { flex: 1; }

    /* Buttons & Inputs */
    button, select, input, textarea { 
      border-radius: 12px;
      border: 1px solid color-mix(in oklab, var(--fg) 15%, transparent);
      background: var(--card);
      color: var(--fg);
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 500;
      transition: var(--transition-fast);
      outline: none;
      width: 100%; /* Make inputs full-width by default */
    }
    
    .row input {
      width: auto; /* Revert for inputs in a row */
    }

    button {
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: auto; /* Buttons should size to content */
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      background: var(--card-hover);
    }
    
    button:active {
        transform: translateY(0px);
    }

    button.primary { 
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border: none;
      color: white;
      font-weight: 600;
    }

    button.primary:hover {
      box-shadow: var(--shadow-lg);
    }
    
    button.ghost {
      background: transparent;
      border-color: color-mix(in oklab, var(--fg) 20%, transparent);
    }
    
    /* IMPROVED: Auth form links */
    .auth-link {
        color: var(--accent);
        background: none;
        border: none;
        padding: 0;
        text-align: right;
        font-size: 12px;
        cursor: pointer;
        width: 100%;
    }
    .auth-link:hover {
        text-decoration: underline;
    }

    /* Tabs */
    .tabs { 
      display: flex; 
      gap: 8px; 
      padding: 16px 0;
      overflow-x: auto;
    }

    .tabs button { 
      padding: 12px 20px;
      white-space: nowrap;
      border-radius: 25px;
      font-weight: 500;
      background: transparent;
      border: none;
    }
    
    .tabs button:hover {
        background: var(--card-hover);
        color: var(--accent);
    }

    .tabs button.active { 
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      box-shadow: var(--shadow);
    }

    /* Grid and Cards */
    .grid { 
      display: grid; 
      gap: 24px;
    }

    .grid.cols-1 { grid-template-columns: 1fr; }
    .grid.cols-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid.cols-3 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }

    .card { 
      background: var(--card);
      border: 1px solid color-mix(in oklab, var(--accent) 10%, transparent);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      transition: var(--transition-medium);
      animation: slideUp 0.4s ease-out forwards;
      opacity: 0;
    }
    
    /* IMPROVEMENT: Staggered animation for cards */
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .card:nth-child(3) { animation-delay: 0.3s; }
    .card:nth-child(4) { animation-delay: 0.4s; }
    .card:nth-child(5) { animation-delay: 0.5s; }
    .card:nth-child(6) { animation-delay: 0.6s; }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: color-mix(in oklab, var(--accent) 30%, transparent);
    }

    .card h3 { 
      margin: 0 0 16px;
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
    }
    
    /* Progress bars */
    .progress-bar {
      height: 8px;
      background: color-mix(in oklab, var(--fg) 10%, transparent);
      border-radius: 4px;
      margin: 12px 0;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    /* Mood scale */
    .mood-scale {
      display: flex;
      gap: 6px;
      margin-top: 12px;
    }
    .mood-point {
      height: 8px;
      flex: 1;
      background: color-mix(in oklab, var(--fg) 15%, transparent);
      border-radius: 4px;
      transition: all 0.3s ease;
      position: relative;
    }
    .mood-point.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
    }
    .mood-point:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      box-shadow: var(--shadow);
    }
    
    /* Focus goal */
    .focus-goal {
      margin-top: 12px;
    }
    .goal-text {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    
    /* Timeframe selector */
    .timeframe-selector {
      display: flex;
      gap: 8px;
      margin: 16px 0;
    }
    .timeframe-btn {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      background: transparent;
      border: 1px solid color-mix(in oklab, var(--fg) 20%, transparent);
      color: var(--fg);
      cursor: pointer;
      transition: var(--transition-fast);
    }
    .timeframe-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    /* Lists */
    ul.clean { list-style: none; }
    ul.clean li { 
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 8px;
      transition: var(--transition-fast);
      border: 1px solid transparent;
      animation: slideUp 0.3s ease-out forwards;
      opacity: 0;
    }

    ul.clean li:nth-child(odd) { background: color-mix(in oklab, var(--fg) 4%, transparent); }
    ul.clean li:hover {
      background: color-mix(in oklab, var(--accent) 8%, transparent);
      border-color: color-mix(in oklab, var(--accent) 20%, transparent);
      transform: translateX(4px);
    }

    /* Mood Selector - ADJUSTED EMOTIONS */
    .mood-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    .mood-option {
      padding: 16px 12px;
      border: 2px solid color-mix(in oklab, var(--fg) 10%, transparent);
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition-medium);
      background: var(--card);
    }
    .mood-option:hover {
      transform: translateY(-4px) scale(1.05);
      border-color: var(--accent);
      box-shadow: var(--shadow);
    }
    .mood-option.selected {
      border-color: var(--accent-2);
      background: color-mix(in oklab, var(--accent-2) 15%, transparent);
      box-shadow: var(--shadow);
      transform: translateY(-2px) scale(1.02);
    }
    .mood-emoji { font-size: 24px; display: block; margin-bottom: 4px; }

    /* Pomodoro Styles */
    .pomodoro-container {
      text-align: center;
      padding: 20px 0;
    }
    .pomodoro-display {
      font-size: 5rem;
      font-weight: 300;
      margin: 20px 0;
      font-feature-settings: "tnum";
      font-variant-numeric: tabular-nums;
      color: var(--accent);
    }
    .pomodoro-controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 30px;
    }
    .pomodoro-settings {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .setting {
      background: color-mix(in oklab, var(--fg) 6%, transparent);
      padding: 16px;
      border-radius: 12px;
    }
    .setting label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--muted);
    }
    .setting select {
      width: 100%;
      background: var(--card);
    }
    
    /* Stats */
    .focus-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat {
      background: color-mix(in oklab, var(--fg) 6%, transparent);
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 4px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .stat-label {
      font-size: 14px;
      color: var(--muted);
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-medium);
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: var(--transition-medium);
      border: 1px solid color-mix(in oklab, var(--accent) 20%, transparent);
      box-shadow: var(--shadow-lg);
    }

    .modal-overlay.show .modal {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-close {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: var(--muted);
    }

    /* Custom number input styling */
    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
      background: var(--card);
      border: 1px solid color-mix(in oklab, var(--fg) 20%, transparent);
      border-radius: 8px;
      padding: 8px 12px;
      width: 80px;
      color: var(--fg);
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Style textareas to match theme */
    textarea {
      background: var(--card);
      border: 1px solid color-mix(in oklab, var(--fg) 20%, transparent);
      color: var(--fg);
      resize: vertical;
      min-height: 120px;
      font-family: inherit;
      line-height: 1.5;
    }

    textarea:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent) 30%, transparent);
    }

    /* Priority star button */
    .star-btn {
      background: none;
      border: none;
      padding: 4px;
      cursor: pointer;
      opacity: 0.5;
      transition: var(--transition-fast);
      color: var(--yellow);
    }

    .star-btn:hover {
      opacity: 1;
      transform: scale(1.2);
    }

    .star-btn.active {
      opacity: 1;
    }

    /* Success feedback */
    .success-feedback {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, var(--green), #10a981);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-lg);
    }
    .success-feedback.show { transform: translateX(0); }
    
    #authFeedback {
        text-align: center;
        margin-top: 15px;
        min-height: 1.2em;
    }
    #authFeedback.error { color: var(--red); }
    #authFeedback.success { color: var(--green); }

    /* IMPROVEMENT: Responsive layout */
    @media (max-width: 768px) {
      .grid.cols-2, .grid.cols-3 {
        grid-template-columns: 1fr;
      }
      .wrap {
        padding: 16px;
      }
      .row {
        gap: 12px;
      }
      header .row {
        flex-direction: column;
        align-items: flex-start;
      }
      .pomodoro-display {
        font-size: 3rem;
      }
      .pomodoro-settings {
        grid-template-columns: 1fr;
      }
    }

    /* Day header */
    .day-header {
      text-align: center;
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--accent);
    }
  </style>
 </head>
 <body>
  <div id="loader">Loading...</div>

  <header>
    <div class="wrap row">
      <h1><i class="icon">dashboard</i> FlowState</h1>
      <div class="spacer"></div>
      <!-- Clock + timezone selector -->
      <div style="display:flex;flex-direction:column;align-items:flex-end;margin-right:12px;font-size:13px;color:var(--muted);" id="clockWrapper">
        <div id="clockDate">--</div>
        <div id="clockTime" style="font-weight:700;color:var(--accent);">--:--</div>
      </div>
      <select id="tzSelect" style="width:220px;margin-right:12px;" title="Select timezone"></select>
      <button id="themeToggle" title="Toggle light/dark mode">
        <span id="themeIcon"></span> 
        <span id="themeText"></span>
      </button>
      <button id="logoutBtn" class="ghost">Logout</button>
    </div>
    <div class="wrap tabs" id="tabs"></div>
  </header>

  <main class="wrap" id="view"></main>

  <div class="success-feedback" id="successFeedback"></div>

  <!-- TEMPLATES -->
  
  <!-- IMPROVED: Auth Template -->
  <template id="authTpl">
    <div class="card" style="max-width: 400px; margin: 50px auto;">
        <h3 id="authTitle">Login</h3>
        <input type="email" id="authEmail" placeholder="Email" style="margin-bottom: 10px;">
        <input type="password" id="authPassword" placeholder="Password" style="margin-bottom: 10px;">
        <button id="forgotPasswordLink" class="auth-link" style="margin-bottom: 20px;">Forgot password?</button>
        
        <button class="primary" id="authActionBtn" style="width: 100%;">Login</button>
        
        <p id="authFeedback"></p>
        
        <button id="authToggle" class="auth-link" style="margin-top: 20px;">No account? Sign up</button>
    </div>
  </template>

  <template id="dashboardTpl">
    <section class="grid cols-3">
      <!-- Cards will be populated by JS -->
    </section>
  </template>

  <template id="tasksTpl">
    <section class="grid cols-2">
      <div class="card">
        <h3><i class="icon">checklist</i> Add Task</h3>
        <div class="row" style="margin-bottom: 20px;">
          <input id="taskTitle" placeholder="What needs to be done?" style="flex: 1;" />
          <button class="primary" id="addTaskBtn">Add Task</button>
        </div>
        <div style="margin-bottom: 16px;">
          <h4 style="color: var(--accent); margin-bottom: 12px;">Priority Tasks (Top 3)</h4>
          <ul class="clean" id="top3List"></ul>
        </div>
        <div>
          <h4 style="color: var(--muted); margin-bottom: 12px;">All Tasks Today</h4>
          <ul class="clean" id="taskList"></ul>
        </div>
      </div>

      <div class="card">
        <h3><i class="icon">repeat</i> Add Habit</h3>
        <div class="row" style="margin-bottom: 20px;">
          <input id="habitTitle" placeholder="e.g., Morning meditation" style="flex: 1;" />
          <button class="primary" id="addHabitBtn">Add</button>
        </div>
        <ul class="clean" id="habitList"></ul>
      </div>
    </section>
  </template>

  <template id="journalTpl">
    <section class="grid cols-2">
      <div class="card">
        <h3><i class="icon">book</i> Daily Journal</h3>
        <div class="row" style="margin-bottom: 16px; gap: 12px; align-items:center;">
          <div style="flex:1;color:var(--muted);font-size:13px;">Entries will be saved with your selected local time.</div>
          <button class="primary" id="saveJournalBtn">Save Entry</button>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">How are you feeling?</label>
          <div class="mood-selector" id="moodSelector">
            <div class="mood-option" data-mood="1"><span class="mood-emoji">😩</span><span>Stressed</span></div>
            <div class="mood-option" data-mood="2"><span class="mood-emoji">😐</span><span>Neutral</span></div>
            <div class="mood-option selected" data-mood="3"><span class="mood-emoji">🙂</span><span>Good</span></div>
            <div class="mood-option" data-mood="4"><span class="mood-emoji">😊</span><span>Happy</span></div>
            <div class="mood-option" data-mood="5"><span class="mood-emoji">🤩</span><span>Great</span></div>
          </div>
        </div>
        
        <textarea id="journalText" placeholder="Reflect on your day... What went well? What could be better?"></textarea>
      </div>
      
      <div class="card">
        <h3><i class="icon">history</i> Recent Entries</h3>
        <ul class="clean" id="journalList"></ul>
      </div>
    </section>
  </template>
  
  <template id="journalModalTpl">
    <div class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>Journal Entry</h3>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="modal-delete" title="Delete entry" style="background:none;border:none;color:var(--red);cursor:pointer;">🗑️</button>
            <button class="modal-close">✕</button>
          </div>
        </div>
        <div class="modal-content">
          <!-- Journal content will be injected here -->
        </div>
      </div>
    </div>
  </template>

  <template id="focusTpl">
    <section class="grid cols-2">
      <div class="card">
        <h3><i class="icon">timer</i> Focus Session</h3>
        <div class="pomodoro-container">
          <div class="pomodoro-display" id="pomodoroTimer">25:00</div>
          <div class="pomodoro-controls">
            <button class="primary" id="startPomodoro">Start Focus</button>
            <button class="ghost" id="resetPomodoro">Reset</button>
          </div>
          <div class="pomodoro-settings">
            <div class="setting">
              <label>Focus Duration (minutes)</label>
              <div class="row" style="gap: 8px;">
                <input type="number" id="focusDuration" min="1" max="120" value="25">
                <div class="row" style="gap: 4px;">
                  <button class="ghost" onclick="quickSetDuration(15)">15</button>
                  <button class="ghost" onclick="quickSetDuration(25)">25</button>
                  <button class="ghost" onclick="quickSetDuration(45)">45</button>
                </div>
              </div>
            </div>
            <div class="setting">
              <label>Short Break</label>
              <select id="shortBreakDuration">
                <option value="5">5 min</option>
                <option value="10" selected>10 min</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3><i class="icon">analytics</i> Focus Analytics</h3>
        <div class="focus-stats">
          <div class="stat">
            <div class="stat-value" id="sessionsCompleted">0</div>
            <div class="stat-label">Today's Sessions</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="focusTime">0m</div>
            <div class="stat-label">Focus Time</div>
          </div>
        </div>
        <div class="focus-history">
          <h4>Recent Sessions</h4>
          <ul class="clean" id="focusHistory"></ul>
        </div>
      </div>
    </section>
  </template>
  
  <script type="module">
    // --- FIREBASE SDK IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        signOut, 
        onAuthStateChanged,
        sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        getDoc, 
        setDoc 
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyCTbPWYcW4XBEc4jmVvfpMNOxHnVvXRc28",
        authDomain: "wellness-3ec86.firebaseapp.com",
        projectId: "wellness-3ec86",
        storageBucket: "wellness-3ec86.firebasestorage.app",
        messagingSenderId: "495194226492",
        appId: "1:495194226492:web:5ecd2df09c2396429a2839"
    };

    // --- FIREBASE INITIALIZATION ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- UTILITIES ---
    const $ = (q, el = document) => el.querySelector(q);
    const $$ = (q, el = document) => Array.from(el.querySelectorAll(q));

    // --- Timezone / Clock ---
    // Expanded list of human-friendly timezone options mapped to representative IANA zones
    const timezones = [
      { v: 'Etc/GMT+12',  l: 'UTC−12:00 — Baker Island, Howland Island (uninhabited)' },
      { v: 'Pacific/Pago_Pago', l: 'UTC−11:00 — American Samoa, Niue' },
      { v: 'Pacific/Honolulu', l: 'UTC−10:00 — Hawaii, Cook Islands' },
      { v: 'Pacific/Marquesas', l: 'UTC−09:30 — Marquesas Islands (French Polynesia)' },
      { v: 'America/Anchorage', l: 'UTC−09:00 — Alaska' },
      { v: 'America/Los_Angeles', l: 'UTC−08:00 — Pacific Time (California, Vancouver)' },
      { v: 'America/Denver', l: 'UTC−07:00 — Mountain Time (Denver, Calgary)' },
      { v: 'America/Chicago', l: 'UTC−06:00 — Central Time (Chicago, Mexico City)' },
      { v: 'America/New_York', l: 'UTC−05:00 — Eastern Time (New York, Toronto, Peru)' },
      { v: 'America/Caracas', l: 'UTC−04:30 — Venezuela (Caracas)' },
      { v: 'America/Halifax', l: 'UTC−04:00 — Atlantic Time (Caribbean, Puerto Rico)' },
      { v: 'America/St_Johns', l: 'UTC−03:30 — Newfoundland (Canada)' },
      { v: 'America/Argentina/Buenos_Aires', l: 'UTC−03:00 — Argentina, Brazil (east coast), Uruguay' },
      { v: 'Atlantic/South_Georgia', l: 'UTC−02:00 — South Georgia & South Sandwich Islands' },
      { v: 'Atlantic/Azores', l: 'UTC−01:00 — Azores (Portugal), Cape Verde' },
      { v: 'Etc/UTC', l: 'UTC±00:00 — GMT, London (winter), Iceland' },
      { v: 'Europe/Paris', l: 'UTC+01:00 — Central Europe (Paris, Berlin, Rome, Madrid, Lagos)' },
      { v: 'Europe/Helsinki', l: 'UTC+02:00 — Eastern Europe, South Africa, Greece, Israel' },
      { v: 'Europe/Moscow', l: 'UTC+03:00 — Moscow, Saudi Arabia, East Africa' },
      { v: 'Asia/Tehran', l: 'UTC+03:30 — Iran' },
      { v: 'Asia/Dubai', l: 'UTC+04:00 — UAE, Oman, Armenia, Azerbaijan' },
      { v: 'Asia/Kabul', l: 'UTC+04:30 — Afghanistan' },
      { v: 'Asia/Karachi', l: 'UTC+05:00 — Pakistan, Uzbekistan, Maldives' },
      { v: 'Asia/Kolkata', l: 'UTC+05:30 — India, Sri Lanka' },
      { v: 'Asia/Kathmandu', l: 'UTC+05:45 — Nepal' },
      { v: 'Asia/Dhaka', l: 'UTC+06:00 — Bangladesh, Kazakhstan' },
      { v: 'Indian/Cocos', l: 'UTC+06:30 — Myanmar, Cocos Islands' },
      { v: 'Asia/Bangkok', l: 'UTC+07:00 — Thailand, Vietnam, Indonesia (Jakarta WIB)' },
      { v: 'Asia/Shanghai', l: 'UTC+08:00 — Philippines, Singapore, Malaysia, China, Western Australia' },
      { v: 'Australia/Eucla', l: 'UTC+08:45 — Eucla (tiny region in Western Australia)' },
      { v: 'Asia/Tokyo', l: 'UTC+09:00 — Japan, Korea' },
      { v: 'Australia/Adelaide', l: 'UTC+09:30 — Central Australia (Adelaide, Darwin)' },
      { v: 'Australia/Sydney', l: 'UTC+10:00 — Eastern Australia (Sydney, Melbourne), Papua New Guinea' },
      { v: 'Australia/Lord_Howe', l: 'UTC+10:30 — Lord Howe Island (Australia)' },
      { v: 'Pacific/Guadalcanal', l: 'UTC+11:00 — Solomon Islands, New Caledonia' },
      { v: 'Pacific/Auckland', l: 'UTC+12:00 — New Zealand, Fiji' },
      { v: 'Pacific/Chatham', l: 'UTC+12:45 — Chatham Islands (New Zealand)' },
      { v: 'Pacific/Tongatapu', l: 'UTC+13:00 — Tonga, Samoa (west), Tokelau' },
      { v: 'Pacific/Kiritimati', l: 'UTC+14:00 — Line Islands (Kiribati) — earliest time zone on Earth' }
    ];
    
    function initTimezone() {
      const saved = localStorage.getItem('tz') || Intl.DateTimeFormat().resolvedOptions().timeZone || 'Etc/UTC';
      state.tz = saved;
      const select = document.getElementById('tzSelect');
      if (!select) return;
      select.innerHTML = timezones.map(t => `<option value="${t.v}" ${t.v===saved? 'selected':''}>${t.l}</option>`).join('');
      select.addEventListener('change', (e) => {
        state.tz = e.target.value; localStorage.setItem('tz', state.tz); updateClock(); renderJournalList();
      });
    }

    function updateClock() {
      const now = new Date();
      const tz = state.tz || Intl.DateTimeFormat().resolvedOptions().timeZone;
      // date line
      const parts = new Intl.DateTimeFormat('en-US', { timeZone: tz, weekday: 'long', year:'numeric', month:'2-digit', day:'2-digit'}).formatToParts(now);
      const weekday = parts.find(p=>p.type==='weekday')?.value || '';
      const month = parts.find(p=>p.type==='month')?.value || '';
      const day = parts.find(p=>p.type==='day')?.value || '';
      const year = parts.find(p=>p.type==='year')?.value || '';
      const dateStr = `${weekday} - ${month}/${day}/${year}`;
      const timeStr = new Intl.DateTimeFormat('en-US', { timeZone: tz, hour:'2-digit', minute:'2-digit', hour12:true }).format(now);
      const dateEl = document.getElementById('clockDate');
      const timeEl = document.getElementById('clockTime');
      if (dateEl) dateEl.textContent = dateStr;
      if (timeEl) timeEl.textContent = timeStr;
    }

    // start clock tick
    setInterval(() => { if (document.body.classList.contains('logged-in')) updateClock(); }, 1000);

    const fmt = {
      today: () => new Date().toISOString().slice(0, 10),
      ymd: d => new Date(d).toISOString().slice(0, 10),
      lastNDates: n => Array.from({ length: n }, (_, i) => {
        const d = new Date();
        d.setDate(d.getDate() - i);
        return d.toISOString().slice(0, 10);
      }),
      formatDateDisplay: dateStr => {
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const date = new Date(dateStr + 'T00:00:00');
        if (date.toDateString() === today.toDateString()) return 'Today';
        if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
        return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      },
      formatDuration: (minutes) => {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
      },
      formatTime: (date) => {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
    };

    // --- GLOBAL STATE ---
    let state = {
      user: null,
      tasks: [],
      habits: [],
      journals: [],
      focusSessions: [],
      theme: localStorage.getItem('theme') || 'dark',
      selectedMood: 3,
      authMode: 'login',
      pomodoroInterval: null,
      pomodoroTimeLeft: 25 * 60,
      pomodoroMode: 'focus'
      , tz: localStorage.getItem('tz') || Intl.DateTimeFormat().resolvedOptions().timeZone
    };

    // --- DATA HANDLING (FIRESTORE) ---
    async function loadData() {
        if (!state.user) return;
        const userDocRef = doc(db, 'users', state.user.uid);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists()) {
            const data = userDoc.data();
            state.tasks = data.tasks || [];
            state.habits = data.habits || [];
            state.journals = data.journals || [];
            state.focusSessions = data.focusSessions || [];
        } else {
            state.tasks = [];
            state.habits = [];
            state.journals = [];
            state.focusSessions = [];
        }
    }

    async function saveData() {
        if (!state.user) return;
        const userDocRef = doc(db, 'users', state.user.uid);
        await setDoc(userDocRef, {
            tasks: state.tasks,
            habits: state.habits,
            journals: state.journals,
            focusSessions: state.focusSessions
        });
    }

    // --- THEME TOGGLE ---
    function applyTheme(theme) {
      document.documentElement.classList.toggle('light', theme === 'light');
      const isLight = theme === 'light';
      $('#themeIcon').textContent = isLight ? '☀️' : '🌙';
      $('#themeText').textContent = isLight ? 'Dark Mode' : 'Light Mode';
    }
    
    $('#themeToggle').addEventListener('click', () => {
      state.theme = state.theme === 'light' ? 'dark' : 'light';
      localStorage.setItem('theme', state.theme);
      applyTheme(state.theme);
      showSuccess(`Switched to ${state.theme} mode`);
    });

    function showSuccess(message) {
      const feedback = $('#successFeedback');
      feedback.textContent = message;
      feedback.classList.add('show');
      setTimeout(() => feedback.classList.remove('show'), 3000);
    }
    
    function showAuthFeedback(message, type = 'error') {
        const el = $('#authFeedback');
        if(el) {
            el.textContent = message;
            el.className = type;
        }
    }

    // --- ROUTER & NAVIGATION ---
    const routes = [
      { id: 'dashboard', label: '📊 Dashboard', tpl: '#dashboardTpl', mount: mountDashboard },
      { id: 'tasks', label: '📋 Tasks & Habits', tpl: '#tasksTpl', mount: mountTasks },
      { id: 'journal', label: '📖 Journal', tpl: '#journalTpl', mount: mountJournal },
      { id: 'focus', label: '⏱️ Focus', tpl: '#focusTpl', mount: mountFocus },
    ];

    function renderTabs(activeId = 'dashboard') {
      const container = $('#tabs');
      container.innerHTML = routes.map(r => 
        `<button class="${r.id === activeId ? 'active' : ''}" data-route-id="${r.id}">${r.label}</button>`
      ).join('');
      $$('#tabs button').forEach(btn => btn.addEventListener('click', () => navigate(btn.dataset.routeId)));
    }

    function navigate(id) {
      if (!state.user) return mountAuth();

      const route = routes.find(r => r.id === id) || routes[0];
      renderTabs(id);
      
      const tpl = $(route.tpl);
      if (!tpl) {
        console.error(`Template not found for route: ${id}`);
        return;
      }

      $('#view').innerHTML = '';
      $('#view').appendChild(tpl.content.cloneNode(true));
      route.mount();
      history.replaceState({}, '', `#${route.id}`);
    }

    // --- AUTHENTICATION ---
    function mountAuth() {
        $('#view').innerHTML = '';
        $('#view').appendChild($('#authTpl').content.cloneNode(true));
        
        renderAuthView();

        $('#authActionBtn').addEventListener('click', handleAuthAction);
        $('#authToggle').addEventListener('click', toggleAuthMode);
        $('#forgotPasswordLink').addEventListener('click', handleForgotPassword);
    }
    
    function renderAuthView() {
        const isLogin = state.authMode === 'login';
        
        $('#authTitle').textContent = isLogin ? 'Login' : 'Create Account';
        $('#authActionBtn').textContent = isLogin ? 'Login' : 'Sign Up';
        $('#forgotPasswordLink').style.display = isLogin ? 'block' : 'none';
        $('#authToggle').textContent = isLogin ? 'No account? Sign up' : 'Already have an account? Login';
        showAuthFeedback('', 'error');
    }

    function toggleAuthMode() {
        state.authMode = state.authMode === 'login' ? 'signup' : 'login';
        renderAuthView();
    }

    async function handleAuthAction() {
        if (state.authMode === 'login') {
            await handleLogin();
        } else {
            await handleSignup();
        }
    }
    
    async function handleLogin() {
        const email = $('#authEmail').value;
        const password = $('#authPassword').value;
        if (!email || !password) {
            showAuthFeedback('Please enter both email and password.');
            return;
        }
        showAuthFeedback('');
        try {
            await signInWithEmailAndPassword(auth, email, password);
            showSuccess('Logged in successfully!');
        } catch (error) {
            showAuthFeedback(error.message);
        }
    }
    
    async function handleSignup() {
        const email = $('#authEmail').value;
        const password = $('#authPassword').value;
        if (!email || password.length < 6) {
            showAuthFeedback('Please enter a valid email and a password of at least 6 characters.');
            return;
        }
        showAuthFeedback('');
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            showSuccess('Account created! Welcome!');
        } catch (error) {
            showAuthFeedback(error.message);
        }
    }
    
    async function handleForgotPassword() {
        const email = $('#authEmail').value;
        if (!email) {
            showAuthFeedback('Please enter your email address to reset your password.');
            return;
        }
        showAuthFeedback('');
        try {
            await sendPasswordResetEmail(auth, email);
            showAuthFeedback('Password reset email sent! Check your inbox.', 'success');
        } catch (error) {
            showAuthFeedback(error.message);
        }
    }
    
    $('#logoutBtn').addEventListener('click', () => {
        signOut(auth);
        showSuccess('Logged out.');
    });

    // --- MOUNT FUNCTIONS ---
    function mountDashboard() {
      const view = $('#view');
      const grid = view.querySelector('.grid');
      if (!grid) {
        console.error('Dashboard grid not found; aborting mountDashboard');
        // still try to render a simple fallback message
        view.innerHTML = '<div class="card" style="padding:24px;">Unable to load dashboard.</div>';
        return;
      }

      const today = fmt.today();
      // Day # header since account creation (avoid duplicates)
      let dayCount = 1;
      if (state.user && state.user.metadata && state.user.metadata.creationTime) {
        const created = new Date(state.user.metadata.creationTime);
        const createdDate = new Date(created.getFullYear(), created.getMonth(), created.getDate());
        const diff = Math.floor((new Date(fmt.today() + 'T00:00:00') - createdDate) / 864e5) + 1;
        dayCount = diff > 0 ? diff : 1;
      }
      let dayHeader = document.getElementById('dayHeader');
      if (dayHeader) {
        dayHeader.textContent = `Day ${dayCount}`;
      } else {
        dayHeader = document.createElement('div');
        dayHeader.id = 'dayHeader';
        dayHeader.className = 'day-header';
        dayHeader.textContent = `Day ${dayCount}`;
        view.insertBefore(dayHeader, grid);
      }

      // Tasks summary: compute counts using lastDone (done for today)
      const allTasks = state.tasks || [];
      const totalTasks = allTasks.length;
      const doneCount = allTasks.filter(t => t.lastDone === today).length;
      const top3 = allTasks.filter(t => t.priority && t.lastDone !== today).slice(0, 3);

      // Mood data for selected timeframe (default last 30 days)
      const moodEntries = state.journals.filter(j => j.mood);
      const moodAvg = moodEntries.length ? (moodEntries.reduce((sum, j) => sum + Number(j.mood), 0) / moodEntries.length).toFixed(1) : '-';

      const todayFocus = state.focusSessions.filter(s => s.date === today && s.mode === 'focus');
      const focusMinutes = todayFocus.reduce((sum, s) => sum + s.duration, 0);

      const cards = [
        {
          icon: 'check_circle',
          title: 'Task Completion',
          content: `
            <div class="kpi">${doneCount}/${totalTasks}</div>
            <div class="progress-bar">
              <div class="progress" style="width: ${totalTasks ? (doneCount/totalTasks*100) : 0}%"></div>
            </div>
            ${top3.length ? `<div class="muted">${top3.map(t => t.title).join(' • ')}</div>` : '<div class="muted">No priority tasks</div>'}
          `
        },
        {
          icon: 'mood',
          title: 'Wellbeing',
          content: `
            <div class="kpi">${moodAvg}/5</div>
            <div class="muted">${getMoodDescription(parseFloat(moodAvg) || moodAvg)}</div>
            <div class="mood-scale">
              ${[1,2,3,4,5].map(i => `\n              <div class="mood-point ${i <= (moodAvg === '-' ? 0 : moodAvg) ? 'active' : ''}" data-tooltip="${getMoodLabel(i)}"></div>\n            `).join('')}
            </div>
          `
        },
        {
          icon: 'timer',
          title: 'Focus',
          content: `
            <div class="kpi">${focusMinutes}m</div>
            <div class="muted">${todayFocus.length} session${todayFocus.length !== 1 ? 's' : ''} today</div>
            <div class="focus-goal">
              <div class="goal-text">${Math.floor(focusMinutes/60)}h ${focusMinutes%60}m of 4h goal</div>
              <div class="progress-bar">
                <div class="progress" style="width: ${Math.min(focusMinutes/240*100, 100)}%"></div>
              </div>
            </div>
          `
        }
      ];

      grid.innerHTML = cards.map(c => `
        <div class="card">
          <h3><i class="icon">${c.icon}</i> ${c.title}</h3>
          ${c.content}
        </div>
      `).join('');

      // Add timeframe selector for mood data (safe guard)
      try { addTimeframeSelector(); } catch (err) { console.warn('Timeframe selector init failed', err); }
    }

    function getMoodDescription(avg) {
        if (!avg || avg === '-') return "No data yet";
        if (avg < 2) return "Feeling stressed";
        if (avg < 3) return "Could be better";
        if (avg < 4) return "Doing alright";
        if (avg < 4.5) return "Feeling good";
        return "Excellent mood!";
    }

    function getMoodLabel(level) {
        const moods = {
            1: "Very poor",
            2: "Poor",
            3: "Neutral",
            4: "Good",
            5: "Excellent"
        };
        return moods[level];
    }

    function addTimeframeSelector() {
        const container = $('.card:nth-child(2)'); // Mood card
        const selector = document.createElement('div');
        selector.className = 'timeframe-selector';
        selector.innerHTML = `
            <button class="timeframe-btn active" data-days="7">Week</button>
            <button class="timeframe-btn" data-days="30">Month</button>
            <button class="timeframe-btn" data-days="90">Quarter</button>
            <button class="timeframe-btn" data-days="365">Year</button>
        `;
        container.querySelector('.mood-scale').insertAdjacentElement('beforebegin', selector);
        
        selector.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                $$('.timeframe-btn', selector).forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                updateMoodDisplay(parseInt(e.target.dataset.days, 10));
            }
        });
    }

    function updateMoodDisplay(days) {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - days);
        
        const moodEntries = state.journals.filter(j => j.mood && new Date(j.date) >= cutoffDate);
        const moodAvg = moodEntries.length ? (moodEntries.reduce((sum, j) => sum + Number(j.mood), 0) / moodEntries.length).toFixed(1) : '-';
        const moodAvgNum = moodAvg === '-' ? '-' : parseFloat(moodAvg);
        
        const kpiEl = document.querySelector('.card:nth-child(2) .kpi');
        const mutedEl = document.querySelector('.card:nth-child(2) .muted');
        if (kpiEl) kpiEl.textContent = `${moodAvg}/5`;
        if (mutedEl) mutedEl.textContent = getMoodDescription(moodAvgNum);
        
        // Update mood scale
        $$('.mood-point').forEach((point, i) => {
            if (moodAvgNum === '-') point.classList.remove('active');
            else point.classList.toggle('active', i < moodAvgNum);
        });
    }

    function mountTasks() {
         renderTaskLists();
         renderHabits();
         
         $('#addTaskBtn').addEventListener('click', addTask);
         $('#taskTitle').addEventListener('keypress', e => e.key === 'Enter' && addTask());
         
         $('#addHabitBtn').addEventListener('click', addHabit);
         $('#habitTitle').addEventListener('keypress', e => e.key === 'Enter' && addHabit());

         // Attach click handlers to both task lists using querySelectorAll helper
         $$('#taskList, #top3List').forEach(el => el.addEventListener('click', handleTaskClick));
         $('#habitList').addEventListener('click', handleHabitClick);
     }
     
    function mountJournal() {
        // journalDate input was removed; journal entries use selected timezone/current time
        renderJournalList();
        $('#saveJournalBtn').addEventListener('click', saveJournalEntry);
        $('#moodSelector').addEventListener('click', selectMood);
    }

    function mountFocus() {
        renderFocusStats();
        renderFocusHistory();
        
        $('#startPomodoro').addEventListener('click', togglePomodoro);
        $('#resetPomodoro').addEventListener('click', resetPomodoro);
        // Attach change listeners to both inputs
        $$('#focusDuration, #shortBreakDuration').forEach(el => el.addEventListener('change', resetPomodoro));

        // Attach quick preset buttons if present
        $$('.pomodoro-settings .ghost').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const v = Number(e.target.textContent.trim());
                if (!isNaN(v) && v > 0) quickSetDuration(v);
            });
        });
    }

    // --- TASKS & HABITS LOGIC ---
    function addTask() {
        const input = $('#taskTitle');
        if (!input.value.trim()) return;
        // Tasks persist across days; 'lastDone' tracks daily completion. If lastDone === today the task is treated as done for that day.
        state.tasks.unshift({ id: Date.now(), title: input.value.trim(), completed: false, lastDone: null, priority: false });
        saveData();
        input.value = '';
        renderTaskLists();
        showSuccess('Task added!');
    }
    
    function addHabit() {
        const input = $('#habitTitle');
        if (!input.value.trim()) return;
        state.habits.unshift({ id: Date.now(), title: input.value.trim(), streak: 0, lastDone: null });
        saveData();
        input.value = '';
        renderHabits();
        showSuccess('Habit added!');
    }

    function renderTaskLists() {
        const today = fmt.today();
        const all = state.tasks || [];

        // Priority (top 3) shows only priority tasks not done today
        const priorityTasks = all.filter(t => t.priority && t.lastDone !== today).slice(0, 3);
        $('#top3List').innerHTML = priorityTasks.length ? 
            priorityTasks.map(t => taskItem(t, true)).join('') : 
            '<li style="opacity:1" class="muted">No priority tasks!</li>';

        // Show all tasks; mark visually if done for today
        const sortedTasks = [...all].sort((a, b) => {
            const aPriority = a.priority ? 1 : 0;
            const bPriority = b.priority ? 1 : 0;
            if (aPriority !== bPriority) return bPriority - aPriority;
            const aDone = a.lastDone === today ? 1 : 0;
            const bDone = b.lastDone === today ? 1 : 0;
            return aDone - bDone; // show not-done first
        });

        $('#taskList').innerHTML = sortedTasks.length ? 
            sortedTasks.map(t => taskItem(t)).join('') : 
            '<li style="opacity:1" class="muted">No tasks for today. Add one!</li>';
    }
    
    function renderHabits() {
        const list = $('#habitList');
        list.innerHTML = state.habits.length ? state.habits.map(habitItem).join('') : `<li style="opacity:1" class="muted">No habits yet. Add one!</li>`;
    }
    
    function taskItem(t, isPriority = false) {
        const doneToday = t.lastDone === fmt.today();
        const titleStyle = doneToday ? 'text-decoration: line-through; color:var(--muted);' : '';
        const checkbox = `<input type="checkbox" data-id="${t.id}" data-action="toggle" ${doneToday ? 'checked' : ''} />`;
        const doneBtnLabel = doneToday ? 'Undo' : 'Done';
        return `
            <li style="${doneToday ? 'opacity: 0.7;' : ''}">
                <div class="row" style="gap: 12px; flex: 1;">
                    ${checkbox}
                    <span style="${titleStyle}">${t.title}</span>
                </div>
                <div class="row" style="gap: 8px;">
                    <button class="star-btn ${t.priority ? 'active' : ''}" data-id="${t.id}" data-action="priority" title="Mark as priority">⭐</button>
                    <button class="ghost" data-id="${t.id}" data-action="done" title="Mark done for today">${doneBtnLabel}</button>
                    <button class="ghost" data-id="${t.id}" data-action="delete" title="Delete task">🗑️</button>
                </div>
            </li>`;
    }
    
    function habitItem(h) {
        const doneToday = h.lastDone === fmt.today();
        return `
            <li>
                <div style="flex:1;">
                    <div style="font-weight: 600;">${h.title}</div>
                    <div class="muted">🔥 ${h.streak || 0} day streak</div>
                </div>
                <div class="row">
                    <button data-id="${h.id}" data-action="complete" class="${doneToday ? 'ghost' : 'primary'}" ${doneToday ? 'disabled' : ''}>
                        ${doneToday ? '✅ Done' : 'Complete'}
                    </button>
                    <button data-id="${h.id}" data-action="delete" class="ghost" title="Delete habit">🗑️</button>
                </div>
            </li>`;
    }

    function handleTaskClick(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        
        const id = Number(target.dataset.id);
        const { action } = target.dataset;
        const task = state.tasks.find(t => t.id === id);

        const today = fmt.today();
        if (action === 'toggle' && task) {
            // Toggle done for today
            if (task.lastDone === today) { task.lastDone = null; showSuccess('Marked as not done for today'); }
            else { task.lastDone = today; showSuccess('Marked done for today'); }
        } else if (action === 'priority' && task) {
             task.priority = !task.priority;
             showSuccess(task.priority ? 'Added to priorities!' : 'Removed from priorities');
        } else if (action === 'done' && task) {
            // Button toggles done state as well
            if (task.lastDone === today) { task.lastDone = null; showSuccess('Undone for today'); }
            else { task.lastDone = today; showSuccess('Marked done for today'); }
          } else if (action === 'delete') {
              if (confirm('Delete this task?')) {
                  state.tasks = state.tasks.filter(t => t.id !== id);
                  showSuccess('Task deleted.');
              }
          }
          saveData();
          renderTaskLists();
      }
    
    function handleHabitClick(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const id = Number(target.dataset.id);
        const { action } = target.dataset;
        const habit = state.habits.find(h => h.id === id);

        if (action === 'complete' && habit) {
            const today = fmt.today();
            const yesterday = fmt.ymd(new Date(Date.now() - 864e5));
            habit.streak = habit.lastDone === yesterday ? (habit.streak || 0) + 1 : 1;
            habit.lastDone = today;
            showSuccess(`Habit done! ${habit.streak} day streak!`);
        } else if (action === 'delete') {
            if (confirm('Delete this habit?')) {
                state.habits = state.habits.filter(h => h.id !== id);
                showSuccess('Habit deleted.');
            }
        }
        saveData();
        renderHabits();
    }

    // --- JOURNAL LOGIC ---
    function saveJournalEntry() {
        // Use selected timezone to compute the date (yyyy-mm-dd) for journal entry
        const tz = state.tz || Intl.DateTimeFormat().resolvedOptions().timeZone;
        const now = new Date();
        const date = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' }).format(now);
        const time = new Intl.DateTimeFormat('en-US', { timeZone: tz, hour: '2-digit', minute: '2-digit', hour12: true }).format(now);
        const text = $('#journalText').value.trim();
        if (!text) { alert('Please write something in your journal.'); return; }
        
        // Store full ISO timestamp for sorting and time display and timezone used
        const entry = { date, text, mood: state.selectedMood, datetime: now.toISOString(), tz: tz, timeDisplay: time };
        state.journals = state.journals.filter(j => j.date !== date || j.timeDisplay !== time);
        state.journals.unshift(entry);
        saveData();
        renderJournalList();
        showSuccess('Journal entry saved!');
    }

    function loadJournalEntryForDate() {
        const date = $('#journalDate').value;
        const entry = state.journals.find(j => j.date === date);
        
        $('#journalText').value = entry ? entry.text : '';
        state.selectedMood = entry ? entry.mood : 3;
        
        $$('.mood-option').forEach(opt => {
            opt.classList.toggle('selected', Number(opt.dataset.mood) === state.selectedMood);
        });
    }

    function selectMood(e) {
        const target = e.target.closest('.mood-option');
        if (!target) return;
        state.selectedMood = Number(target.dataset.mood);
        $$('.mood-option').forEach(opt => opt.classList.remove('selected'));
        target.classList.add('selected');
    }
    
    function renderJournalList() {
        const list = $('#journalList');
        list.innerHTML = '';
        const moodMap = { 1: '😩', 2: '😐', 3: '🙂', 4: '😊', 5: '🤩' };
        
        // Sort by datetime if available, else by date
        const recent = [...state.journals].sort((a,b) => (b.datetime || b.date).localeCompare(a.datetime || a.date)).slice(0, 7);
        
        if (!recent.length) {
            list.innerHTML = `<li style="opacity:1" class="muted">No recent journal entries.</li>`;
            return;
        }

        function previewWords(text, n = 8){
            if(!text) return '';
            const words = text.split(/\s+/).filter(Boolean);
            return words.length <= n ? text : words.slice(0, n).join(' ') + '...';
        }

        recent.forEach(j => {
            const li = document.createElement('li');
            li.style.cursor = 'pointer';

            const left = document.createElement('div');
            left.style.flex = '1';
            left.innerHTML = `
                <div style="font-weight: 600;">${fmt.formatDateDisplay(j.date)} ${moodMap[j.mood] || ''} <span style="color:var(--muted);font-weight:400">• ${j.timeDisplay || (j.datetime ? new Date(j.datetime).toLocaleTimeString() : '')}</span></div>
                <div class="muted">${previewWords(j.text, 8)}</div>
            `;

            const icon = document.createElement('i');
            icon.className = 'icon';
            icon.textContent = 'chevron_right';

            li.appendChild(left);
            li.appendChild(icon);

            li.addEventListener('click', () => showJournalModal(j.date));

            list.appendChild(li);
        });
    }

    // --- POMODORO/FOCUS LOGIC ---
    function togglePomodoro() {
        const btn = $('#startPomodoro');
        
        if (state.pomodoroInterval) {
            // Pause
            clearInterval(state.pomodoroInterval);
            state.pomodoroInterval = null;
            btn.textContent = 'Resume';
            showSuccess('Focus session paused');
        } else {
            // Start
            btn.textContent = 'Pause';
            state.pomodoroInterval = setInterval(updatePomodoro, 1000);
            showSuccess(`Focus session started - ${state.pomodoroMode === 'focus' ? 'Work time!' : 'Break time!'}`);
        }
    }

    function updatePomodoro() {
        state.pomodoroTimeLeft--;
        
        if (state.pomodoroTimeLeft <= 0) {
            // Session complete
            clearInterval(state.pomodoroInterval);
            state.pomodoroInterval = null;
            
            // Record the completed session
            const now = new Date();
            const duration = state.pomodoroMode === 'focus' 
                ? parseInt($('#focusDuration').value)
                : parseInt($('#shortBreakDuration').value);
            
            state.focusSessions.unshift({
                date: fmt.today(),
                timestamp: now.toISOString(),
                mode: state.pomodoroMode,
                duration: duration
            });
            
            saveData();
            renderFocusStats();
            renderFocusHistory();
            
            // Switch mode
            if (state.pomodoroMode === 'focus') {
                state.pomodoroMode = 'break';
                state.pomodoroTimeLeft = parseInt($('#shortBreakDuration').value) * 60;
                showSuccess('Focus session complete! Take a break.', 5000);
            } else {
                state.pomodoroMode = 'focus';
                state.pomodoroTimeLeft = parseInt($('#focusDuration').value) * 60;
                showSuccess('Break over! Ready for another focus session?', 5000);
            }
            
            // Auto-start next session if enabled
            $('#startPomodoro').textContent = 'Start ' + (state.pomodoroMode === 'focus' ? 'Focus' : 'Break');
            togglePomodoro();
            
            return;
        }
        
        // Update display
        const minutes = Math.floor(state.pomodoroTimeLeft / 60);
        const seconds = state.pomodoroTimeLeft % 60;
        $('#pomodoroTimer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    function resetPomodoro() {
        if (state.pomodoroInterval) {
            clearInterval(state.pomodoroInterval);
            state.pomodoroInterval = null;
        }
        
        state.pomodoroMode = 'focus';
        state.pomodoroTimeLeft = parseInt($('#focusDuration').value) * 60;
        $('#pomodoroTimer').textContent = `${$('#focusDuration').value}:00`;
        $('#startPomodoro').textContent = 'Start Focus';
    }

    function renderFocusStats() {
        const today = fmt.today();
        const todaySessions = state.focusSessions.filter(s => s.date === today && s.mode === 'focus');
        const totalMinutes = todaySessions.reduce((sum, s) => sum + s.duration, 0);
        
        $('#sessionsCompleted').textContent = todaySessions.length;
        $('#focusTime').textContent = `${totalMinutes}m`;
    }

    function renderFocusHistory() {
        const history = $('#focusHistory');
        const recent = [...state.focusSessions].slice(0, 7);
        
        history.innerHTML = recent.length ? recent.map(s => `
            <li>
                <div style="flex:1">
                    <div style="font-weight: 600;">${fmt.formatDateDisplay(s.date)} • ${s.mode === 'focus' ? 'Focus' : 'Break'}</div>
                    <div class="muted">${fmt.formatTime(new Date(s.timestamp))} • ${s.duration} min</div>
                </div>
            </li>
        `).join('') : `<li style="opacity:1" class="muted">No focus sessions yet.</li>`;
    }

    // --- MODAL AND UTILITIES ---
    function showJournalModal(date) {
        const entry = state.journals.find(j => j.date === date);
        if (!entry) return;

        const moodMap = { 1: '😩', 2: '😐', 3: '🙂', 4: '😊', 5: '🤩' };
        
        // Create modal
        const modalTpl = $('#journalModalTpl');
        const modal = modalTpl.content.cloneNode(true);
        document.body.appendChild(modal);
        
        const overlay = document.querySelector('.modal-overlay');
        const content = overlay.querySelector('.modal-content');
        
        // Show timezone-aware time if stored
        const tz = entry.tz || state.tz || Intl.DateTimeFormat().resolvedOptions().timeZone;
        const timeStr = entry.timeDisplay || (entry.datetime ? new Intl.DateTimeFormat('en-US', { timeZone: tz, hour:'2-digit', minute:'2-digit', hour12:true }).format(new Date(entry.datetime)) : '');
        content.innerHTML = `
            <div style="margin-bottom: 20px;">
                <div style="font-size: 1.1em; margin-bottom: 8px; font-weight:700;">${fmt.formatDateDisplay(entry.date)} • ${timeStr} ${moodMap[entry.mood] || ''}</div>
                <div style="white-space: pre-wrap; line-height: 1.6; margin-bottom:12px;">${entry.text}</div>
            </div>
        `;
        
        // Show modal with animation
        requestAnimationFrame(() => overlay.classList.add('show'));
        
        // Close handlers
        const close = () => {
            overlay.classList.remove('show');
            setTimeout(() => overlay.remove(), 300);
        };
        
        overlay.querySelector('.modal-close').addEventListener('click', close);
        const delBtn = overlay.querySelector('.modal-delete');
        if (delBtn) {
            delBtn.addEventListener('click', () => {
                if (!confirm('Delete this journal entry?')) return;
                state.journals = state.journals.filter(j => !(j.date === entry.date && j.datetime === entry.datetime));
                saveData();
                close();
                renderJournalList();
                showSuccess('Journal entry deleted');
            });
        }
        overlay.addEventListener('click', e => {
            if (e.target === overlay) close();
        });
    }

    function quickSetDuration(mins) {
        const input = $('#focusDuration');
        input.value = mins;
        resetPomodoro();
    }

    // --- INITIALIZATION ---
    function init() {
        applyTheme(state.theme);
        initTimezone();
        updateClock();

        onAuthStateChanged(auth, async (user) => {
            // Hide loader once auth state is known
            $('#loader').classList.add('hidden');

            if (user) {
                // User is signed in
                document.body.classList.add('logged-in');
                state.user = user;
                await loadData();
                const hash = location.hash.replace('#', '');
                navigate(routes.some(r => r.id === hash) ? hash : 'dashboard');
            } else {
                // User is signed out
                document.body.classList.remove('logged-in');
                state.user = null;
                state.tasks = []; state.habits = []; state.journals = []; state.focusSessions = []; // Clear local state
                $('#tabs').innerHTML = ''; // Clear tabs
                mountAuth(); // Show the login screen
            }
        });
    }

    // Run the app
    init();

    // Expose certain helpers to window so inline handlers (if any) still work when module scope isn't global
    window.quickSetDuration = quickSetDuration;
    window.showJournalModal = showJournalModal;
    window.updateClock = updateClock;
   </script>
 </body>
 </html>

