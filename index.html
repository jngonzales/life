<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wellness & Productivity Dashboard</title>
  <style>
    /* 
      IMPROVEMENT: Added CSS variables for animations and improved color consistency.
      IMPROVEMENT: Added keyframe animations for fade-in and slide-up effects.
    */
    :root {
      --bg: #0a0e13;
      --bg-secondary: #1a1f29;
      --fg: #e2e8f0;
      --muted: #94a3b8;
      --card: #151b26;
      --card-hover: #1e2533;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-2: #8b5cf6;
      --green: #10b981;
      --red: #ef4444;
      --yellow: #f59e0b;
      --shadow: 0 4px 15px rgba(0,0,0,0.2);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.3);
      --radius: 16px;
      --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-medium: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .light {
      --bg: #f8fafc;
      --bg-secondary: #f1f5f9;
      --fg: #1e293b;
      --muted: #64748b;
      --card: #ffffff;
      --card-hover: #f1f5f9;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --shadow: 0 4px 15px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-secondary) 100%);
      color: var(--fg);
      min-height: 100vh;
      transition: var(--transition-medium);
    }
    
    /* NEW: Loader for initial auth check */
    #loader {
        display: flex;
        align-items: center;
        justify-content: center;
        position: fixed;
        inset: 0;
        font-size: 1.2rem;
        color: var(--muted);
        transition: opacity 0.3s;
        z-index: 2000;
        background: var(--bg);
    }
    #loader.hidden {
        opacity: 0;
        pointer-events: none;
    }


    /* Header */
    header { 
      position: sticky; 
      top: 0; 
      z-index: 100;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      background: color-mix(in oklab, var(--bg) 80%, transparent);
      border-bottom: 1px solid color-mix(in oklab, var(--accent) 15%, transparent);
      display: none; /* Hide header by default */
    }
    
    body.logged-in header {
      display: block; /* Show header only when logged in */
    }


    .wrap { 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 24px;
    }
    
    main.wrap {
      animation: fadeIn 0.5s ease-in-out;
    }

    h1 { 
      font-size: clamp(24px, 4vw, 32px);
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .row { 
      display: flex; 
      gap: 16px; 
      align-items: center; 
      flex-wrap: wrap;
    }

    .spacer { flex: 1; }

    /* Buttons & Inputs */
    button, select, input, textarea { 
      border-radius: 12px;
      border: 1px solid color-mix(in oklab, var(--fg) 15%, transparent);
      background: var(--card);
      color: var(--fg);
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 500;
      transition: var(--transition-fast);
      outline: none;
      width: 100%; /* Make inputs full-width by default */
    }
    
    .row input {
      width: auto; /* Revert for inputs in a row */
    }

    button {
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: auto; /* Buttons should size to content */
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      background: var(--card-hover);
    }
    
    button:active {
        transform: translateY(0px);
    }

    button.primary { 
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border: none;
      color: white;
      font-weight: 600;
    }

    button.primary:hover {
      box-shadow: var(--shadow-lg);
    }
    
    button.ghost {
      background: transparent;
      border-color: color-mix(in oklab, var(--fg) 20%, transparent);
    }
    
    /* IMPROVED: Auth form links */
    .auth-link {
        color: var(--accent);
        background: none;
        border: none;
        padding: 0;
        text-align: right;
        font-size: 12px;
        cursor: pointer;
        width: 100%;
    }
    .auth-link:hover {
        text-decoration: underline;
    }


    /* Tabs */
    .tabs { 
      display: flex; 
      gap: 8px; 
      padding: 16px 0;
      overflow-x: auto;
    }

    .tabs button { 
      padding: 12px 20px;
      white-space: nowrap;
      border-radius: 25px;
      font-weight: 500;
      background: transparent;
      border: none;
    }
    
    .tabs button:hover {
        background: var(--card-hover);
        color: var(--accent);
    }

    .tabs button.active { 
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      box-shadow: var(--shadow);
    }

    /* Grid and Cards */
    .grid { 
      display: grid; 
      gap: 24px;
    }

    .grid.cols-1 { grid-template-columns: 1fr; }
    .grid.cols-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid.cols-3 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }

    .card { 
      background: var(--card);
      border: 1px solid color-mix(in oklab, var(--accent) 10%, transparent);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      transition: var(--transition-medium);
      animation: slideUp 0.4s ease-out forwards;
      opacity: 0;
    }
    
    /* IMPROVEMENT: Staggered animation for cards */
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .card:nth-child(3) { animation-delay: 0.3s; }
    .card:nth-child(4) { animation-delay: 0.4s; }
    .card:nth-child(5) { animation-delay: 0.5s; }
    .card:nth-child(6) { animation-delay: 0.6s; }


    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: color-mix(in oklab, var(--accent) 30%, transparent);
    }

    .card h3 { 
      margin: 0 0 16px;
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
    }
    
    /* Lists */
    ul.clean { list-style: none; }
    ul.clean li { 
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 8px;
      transition: var(--transition-fast);
      border: 1px solid transparent;
      animation: slideUp 0.3s ease-out forwards;
      opacity: 0;
    }

    ul.clean li:nth-child(odd) { background: color-mix(in oklab, var(--fg) 4%, transparent); }
    ul.clean li:hover {
      background: color-mix(in oklab, var(--accent) 8%, transparent);
      border-color: color-mix(in oklab, var(--accent) 20%, transparent);
      transform: translateX(4px);
    }

    /* Mood Selector - ADJUSTED EMOTIONS */
    .mood-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    .mood-option {
      padding: 16px 12px;
      border: 2px solid color-mix(in oklab, var(--fg) 10%, transparent);
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition-medium);
      background: var(--card);
    }
    .mood-option:hover {
      transform: translateY(-4px) scale(1.05);
      border-color: var(--accent);
      box-shadow: var(--shadow);
    }
    .mood-option.selected {
      border-color: var(--accent-2);
      background: color-mix(in oklab, var(--accent-2) 15%, transparent);
      box-shadow: var(--shadow);
      transform: translateY(-2px) scale(1.02);
    }
    .mood-emoji { font-size: 24px; display: block; margin-bottom: 4px; }

    /* Success feedback */
    .success-feedback {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, var(--green), #10a981);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-lg);
    }
    .success-feedback.show { transform: translateX(0); }
    
    #authFeedback {
        text-align: center;
        margin-top: 15px;
        min-height: 1.2em;
    }
    #authFeedback.error { color: var(--red); }
    #authFeedback.success { color: var(--green); }


    /* IMPROVEMENT: Responsive layout */
    @media (max-width: 768px) {
      .grid.cols-2, .grid.cols-3 {
        grid-template-columns: 1fr;
      }
      .wrap {
        padding: 16px;
      }
      .row {
        gap: 12px;
      }
      header .row {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div id="loader">Loading...</div>

  <header>
    <div class="wrap row">
      <h1>üßò‚Äç‚ôÇÔ∏è Wellness Dashboard</h1>
      <div class="spacer"></div>
      <button id="themeToggle" title="Toggle light/dark mode">
        <span id="themeIcon"></span> 
        <span id="themeText"></span>
      </button>
      <button id="logoutBtn" class="ghost">Logout</button>
    </div>
    <div class="wrap tabs" id="tabs"></div>
  </header>

  <main class="wrap" id="view"></main>

  <div class="success-feedback" id="successFeedback"></div>

  <!-- TEMPLATES -->
  
  <!-- IMPROVED: Auth Template -->
  <template id="authTpl">
    <div class="card" style="max-width: 400px; margin: 50px auto;">
        <h3 id="authTitle">Login</h3>
        <input type="email" id="authEmail" placeholder="Email" style="margin-bottom: 10px;">
        <input type="password" id="authPassword" placeholder="Password" style="margin-bottom: 10px;">
        <button id="forgotPasswordLink" class="auth-link" style="margin-bottom: 20px;">Forgot password?</button>
        
        <button class="primary" id="authActionBtn" style="width: 100%;">Login</button>
        
        <p id="authFeedback"></p>
        
        <button id="authToggle" class="auth-link" style="margin-top: 20px;">No account? Sign up</button>
    </div>
  </template>


  <template id="dashboardTpl">
    <section class="grid cols-3">
      <!-- Cards will be populated by JS -->
    </section>
  </template>

  <template id="tasksTpl">
    <section class="grid cols-2">
      <div class="card">
        <h3>üìã Add Task</h3>
        <div class="row" style="margin-bottom: 20px;">
          <input id="taskTitle" placeholder="What needs to be done?" style="flex: 1;" />
          <button class="primary" id="addTaskBtn">‚ú® Add Task</button>
        </div>
        <div style="margin-bottom: 16px;">
          <h4 style="color: var(--accent); margin-bottom: 12px;">üéØ Priority Tasks (Top 3)</h4>
          <ul class="clean" id="top3List"></ul>
        </div>
        <div>
          <h4 style="color: var(--muted); margin-bottom: 12px;">üìù All Tasks Today</h4>
          <ul class="clean" id="taskList"></ul>
        </div>
      </div>

      <div class="card">
        <h3>üéØ Add Habit</h3>
        <div class="row" style="margin-bottom: 20px;">
          <input id="habitTitle" placeholder="e.g., Morning meditation" style="flex: 1;" />
          <button class="primary" id="addHabitBtn">‚ûï Add</button>
        </div>
        <ul class="clean" id="habitList"></ul>
      </div>
    </section>
  </template>

  <template id="journalTpl">
    <section class="grid cols-2">
      <div class="card">
        <h3>üìñ Daily Journal</h3>
        <div class="row" style="margin-bottom: 16px; gap: 12px;">
          <input id="journalDate" type="date" />
          <button class="primary" id="saveJournalBtn">üíæ Save Entry</button>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">How are you feeling?</label>
          <div class="mood-selector" id="moodSelector">
            <div class="mood-option" data-mood="1"><span class="mood-emoji">üò©</span><span>Stressed</span></div>
            <div class="mood-option" data-mood="2"><span class="mood-emoji">üòê</span><span>Neutral</span></div>
            <div class="mood-option selected" data-mood="3"><span class="mood-emoji">üôÇ</span><span>Good</span></div>
            <div class="mood-option" data-mood="4"><span class="mood-emoji">üòä</span><span>Happy</span></div>
            <div class="mood-option" data-mood="5"><span class="mood-emoji">ü§©</span><span>Great</span></div>
          </div>
        </div>
        
        <textarea id="journalText" placeholder="Reflect on your day... What went well? What could be better?"></textarea>
      </div>
      
      <div class="card">
        <h3>üìö Recent Entries</h3>
        <ul class="clean" id="journalList"></ul>
      </div>
    </section>
  </template>
  
  <script type="module">
    // --- FIREBASE SDK IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        signOut, 
        onAuthStateChanged,
        sendPasswordResetEmail // NEW: Import for password reset
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        getDoc, 
        setDoc 
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyCTbPWYcW4XBEc4jmVvfpMNOxHnVvXRc28",
        authDomain: "wellness-3ec86.firebaseapp.com",
        projectId: "wellness-3ec86",
        storageBucket: "wellness-3ec86.firebasestorage.app",
        messagingSenderId: "495194226492",
        appId: "1:495194226492:web:5ecd2df09c2396429a2839"
    };

    // --- FIREBASE INITIALIZATION ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- UTILITIES ---
    const $ = (q, el = document) => el.querySelector(q);
    const $$ = (q, el = document) => Array.from(el.querySelectorAll(q));

    const fmt = {
      today: () => new Date().toISOString().slice(0, 10),
      ymd: d => new Date(d).toISOString().slice(0, 10),
      lastNDates: n => Array.from({ length: n }, (_, i) => {
        const d = new Date();
        d.setDate(d.getDate() - i);
        return d.toISOString().slice(0, 10);
      }),
      formatDateDisplay: dateStr => {
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const date = new Date(dateStr + 'T00:00:00');
        if (date.toDateString() === today.toDateString()) return 'Today';
        if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
        return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      }
    };

    // --- GLOBAL STATE ---
    let state = {
      user: null, // To store the logged-in user object
      tasks: [],
      habits: [],
      journals: [],
      theme: localStorage.getItem('theme') || 'dark', // Get theme from local storage
      selectedMood: 3,
      authMode: 'login' // NEW: 'login' or 'signup'
    };

    // --- DATA HANDLING (FIRESTORE) ---
    async function loadData() {
        if (!state.user) return;
        const userDocRef = doc(db, 'users', state.user.uid);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists()) {
            const data = userDoc.data();
            state.tasks = data.tasks || [];
            state.habits = data.habits || [];
            state.journals = data.journals || [];
        } else {
            // First time user, initialize with empty data
            state.tasks = [];
            state.habits = [];
            state.journals = [];
        }
    }

    async function saveData() {
        if (!state.user) return;
        const userDocRef = doc(db, 'users', state.user.uid);
        await setDoc(userDocRef, {
            tasks: state.tasks,
            habits: state.habits,
            journals: state.journals
        });
    }


    // --- THEME TOGGLE ---
    function applyTheme(theme) {
      document.documentElement.classList.toggle('light', theme === 'light');
      const isLight = theme === 'light';
      $('#themeIcon').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
      $('#themeText').textContent = isLight ? 'Dark Mode' : 'Light Mode';
    }
    
    $('#themeToggle').addEventListener('click', () => {
      state.theme = state.theme === 'light' ? 'dark' : 'light';
      localStorage.setItem('theme', state.theme); // Save theme locally
      applyTheme(state.theme);
      showSuccess(`Switched to ${state.theme} mode`);
    });

    function showSuccess(message) {
      const feedback = $('#successFeedback');
      feedback.textContent = message;
      feedback.classList.add('show');
      setTimeout(() => feedback.classList.remove('show'), 3000);
    }
    
    // IMPROVED: Single function for auth feedback
    function showAuthFeedback(message, type = 'error') {
        const el = $('#authFeedback');
        if(el) {
            el.textContent = message;
            el.className = type; // 'error' or 'success'
        }
    }

    // --- ROUTER & NAVIGATION ---
    const routes = [
      { id: 'dashboard', label: 'üìä Dashboard', tpl: '#dashboardTpl', mount: mountDashboard },
      { id: 'tasks', label: 'üìã Tasks & Habits', tpl: '#tasksTpl', mount: mountTasks },
      { id: 'journal', label: 'üìñ Journal', tpl: '#journalTpl', mount: mountJournal },
    ];

    function renderTabs(activeId = 'dashboard') {
      const container = $('#tabs');
      container.innerHTML = routes.map(r => 
        `<button class="${r.id === activeId ? 'active' : ''}" data-route-id="${r.id}">${r.label}</button>`
      ).join('');
      $$('#tabs button').forEach(btn => btn.addEventListener('click', () => navigate(btn.dataset.routeId)));
    }

    function navigate(id) {
      if (!state.user) return mountAuth(); // If not logged in, show auth screen

      const route = routes.find(r => r.id === id) || routes[0];
      renderTabs(id);
      
      const tpl = $(route.tpl);
      if (!tpl) {
        console.error(`Template not found for route: ${id}`);
        return;
      }

      $('#view').innerHTML = ''; // Clear previous view
      $('#view').appendChild(tpl.content.cloneNode(true));
      route.mount();
      history.replaceState({}, '', `#${route.id}`);
    }

    // --- AUTHENTICATION (IMPROVED) ---
    function mountAuth() {
        $('#view').innerHTML = '';
        $('#view').appendChild($('#authTpl').content.cloneNode(true));
        
        // Initial render based on state.authMode
        renderAuthView();

        $('#authActionBtn').addEventListener('click', handleAuthAction);
        $('#authToggle').addEventListener('click', toggleAuthMode);
        $('#forgotPasswordLink').addEventListener('click', handleForgotPassword);
    }
    
    function renderAuthView() {
        const isLogin = state.authMode === 'login';
        
        $('#authTitle').textContent = isLogin ? 'Login' : 'Create Account';
        $('#authActionBtn').textContent = isLogin ? 'Login' : 'Sign Up';
        $('#forgotPasswordLink').style.display = isLogin ? 'block' : 'none';
        $('#authToggle').textContent = isLogin ? 'No account? Sign up' : 'Already have an account? Login';
        showAuthFeedback('', 'error'); // Clear any previous feedback
    }

    function toggleAuthMode() {
        state.authMode = state.authMode === 'login' ? 'signup' : 'login';
        renderAuthView();
    }

    async function handleAuthAction() {
        if (state.authMode === 'login') {
            await handleLogin();
        } else {
            await handleSignup();
        }
    }
    
    async function handleLogin() {
        const email = $('#authEmail').value;
        const password = $('#authPassword').value;
        if (!email || !password) {
            showAuthFeedback('Please enter both email and password.');
            return;
        }
        showAuthFeedback('');
        try {
            await signInWithEmailAndPassword(auth, email, password);
            showSuccess('Logged in successfully!');
        } catch (error) {
            showAuthFeedback(error.message);
        }
    }
    
    async function handleSignup() {
        const email = $('#authEmail').value;
        const password = $('#authPassword').value;
        if (!email || password.length < 6) {
            showAuthFeedback('Please enter a valid email and a password of at least 6 characters.');
            return;
        }
        showAuthFeedback('');
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            showSuccess('Account created! Welcome!');
        } catch (error) {
            showAuthFeedback(error.message);
        }
    }
    
    async function handleForgotPassword() {
        const email = $('#authEmail').value;
        if (!email) {
            showAuthFeedback('Please enter your email address to reset your password.');
            return;
        }
        showAuthFeedback('');
        try {
            await sendPasswordResetEmail(auth, email);
            showAuthFeedback('Password reset email sent! Check your inbox.', 'success');
        } catch (error) {
            showAuthFeedback(error.message);
        }
    }
    
    $('#logoutBtn').addEventListener('click', () => {
        signOut(auth);
        showSuccess('Logged out.');
    });


    // --- MOUNT FUNCTIONS ---
    function mountDashboard() {
        const grid = $('.grid');
        const today = fmt.today();
        
        const todayTasks = state.tasks.filter(t => (t.timestamp || today) === today);
        const doneCount = todayTasks.filter(t => t.completed).length;
        const top3 = state.tasks.filter(t => (t.timestamp || today) === today && !t.completed).slice(0, 3);
        const moodEntries = state.journals.filter(j => j.mood).slice(0, 7);
        const moodAvg = moodEntries.length ? (moodEntries.reduce((sum, j) => sum + Number(j.mood), 0) / moodEntries.length).toFixed(1) : '-';
        const topHabits = [...state.habits].sort((a,b) => (b.streak || 0) - (a.streak || 0)).slice(0, 3);

        const cards = [
            { title: "Today's Tasks", content: `<div class="kpi">${doneCount}/${todayTasks.length}</div><div class="muted">${top3.length ? top3.map(t => t.title).join(' ‚Ä¢ ') : 'All tasks done! üéâ'}</div>` },
            { title: "7-Day Mood Average", content: `<div class="kpi">${moodAvg}</div><div class="muted">üò© stressed ‚Üí ü§© great</div>`},
            { title: "üî• Top Habit Streaks", content: topHabits.length ? topHabits.map(h => `<div>${h.title}: <b>${h.streak || 0} days</b></div>`).join('') : '<div class="muted">Add habits to build streaks!</div>'}
        ];
        
        grid.innerHTML = cards.map(c => `<div class="card"><h3>${c.title}</h3>${c.content}</div>`).join('');
    }

    function mountTasks() {
      renderTaskLists();
      renderHabits();
      
      $('#addTaskBtn').addEventListener('click', addTask);
      $('#taskTitle').addEventListener('keypress', e => e.key === 'Enter' && addTask());
      
      $('#addHabitBtn').addEventListener('click', addHabit);
      $('#habitTitle').addEventListener('keypress', e => e.key === 'Enter' && addHabit());

      $('#taskList, #top3List').addEventListener('click', handleTaskClick);
      $('#habitList').addEventListener('click', handleHabitClick);
    }
    
    function mountJournal() {
        const journalDate = $('#journalDate');
        journalDate.value = fmt.today();
        
        renderJournalList();
        loadJournalEntryForDate();

        $('#saveJournalBtn').addEventListener('click', saveJournalEntry);
        $('#moodSelector').addEventListener('click', selectMood);
        
        journalDate.addEventListener('change', loadJournalEntryForDate);
    }

    // --- TASKS & HABITS LOGIC ---
    function addTask() {
        const input = $('#taskTitle');
        if (!input.value.trim()) return;
        state.tasks.unshift({ id: Date.now(), title: input.value.trim(), completed: false, timestamp: fmt.today() });
        saveData();
        input.value = '';
        renderTaskLists();
        showSuccess('Task added!');
    }
    
    function addHabit() {
        const input = $('#habitTitle');
        if (!input.value.trim()) return;
        state.habits.unshift({ id: Date.now(), title: input.value.trim(), streak: 0, lastDone: null });
        saveData();
        input.value = '';
        renderHabits();
        showSuccess('Habit added!');
    }

    function renderTaskLists() {
        const today = fmt.today();
        const allToday = state.tasks.filter(t => (t.timestamp || today) === today);
        
        const top3 = allToday.filter(t => !t.completed).slice(0, 3);
        $('#top3List').innerHTML = top3.length ? top3.map(t => taskItem(t, true)).join('') : `<li style="opacity:1" class="muted">No priority tasks!</li>`;
        
        $('#taskList').innerHTML = allToday.length ? allToday.map(t => taskItem(t)).join('') : `<li style="opacity:1" class="muted">No tasks for today. Add one!</li>`;
    }
    
    function renderHabits() {
        const list = $('#habitList');
        list.innerHTML = state.habits.length ? state.habits.map(habitItem).join('') : `<li style="opacity:1" class="muted">No habits yet. Add one!</li>`;
    }
    
    function taskItem(t, isPriority = false) {
      return `
        <li style="${t.completed ? 'opacity: 0.6;' : ''}">
          <div class="row" style="gap: 12px; flex: 1;">
            <input type="checkbox" data-id="${t.id}" data-action="toggle" ${t.completed ? 'checked' : ''} />
            <span style="${t.completed ? 'text-decoration: line-through;' : ''}">${t.title}</span>
            ${isPriority ? '<span class="pill warning">‚≠ê Priority</span>' : ''}
          </div>
          <button class="ghost" data-id="${t.id}" data-action="delete" title="Delete task">üóëÔ∏è</button>
        </li>`;
    }
    
    function habitItem(h) {
        const doneToday = h.lastDone === fmt.today();
        return `
            <li>
                <div style="flex:1;">
                  <div style="font-weight: 600;">${h.title}</div>
                  <div class="muted">üî• ${h.streak || 0} day streak</div>
                </div>
                <div class="row">
                    <button data-id="${h.id}" data-action="complete" class="${doneToday ? 'ghost' : 'primary'}" ${doneToday ? 'disabled' : ''}>
                        ${doneToday ? '‚úÖ Done' : 'Complete'}
                    </button>
                    <button data-id="${h.id}" data-action="delete" class="ghost" title="Delete habit">üóëÔ∏è</button>
                </div>
            </li>`;
    }

    function handleTaskClick(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        
        const id = Number(target.dataset.id);
        const { action } = target.dataset;

        if (action === 'toggle') {
            const task = state.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                if(task.completed) showSuccess('Task complete! üéâ');
            }
        } else if (action === 'delete') {
            if (confirm('Delete this task?')) {
                state.tasks = state.tasks.filter(t => t.id !== id);
                showSuccess('Task deleted.');
            }
        }
        saveData();
        renderTaskLists();
    }
    
    function handleHabitClick(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const id = Number(target.dataset.id);
        const { action } = target.dataset;
        const habit = state.habits.find(h => h.id === id);

        if (action === 'complete' && habit) {
            const today = fmt.today();
            const yesterday = fmt.ymd(new Date(Date.now() - 864e5));
            habit.streak = habit.lastDone === yesterday ? (habit.streak || 0) + 1 : 1;
            habit.lastDone = today;
            showSuccess(`Habit done! ${habit.streak} day streak!`);
        } else if (action === 'delete') {
            if (confirm('Delete this habit?')) {
                state.habits = state.habits.filter(h => h.id !== id);
                showSuccess('Habit deleted.');
            }
        }
        saveData();
        renderHabits();
    }


    // --- JOURNAL LOGIC ---
    function saveJournalEntry() {
        const date = $('#journalDate').value;
        const text = $('#journalText').value.trim();
        if (!text) { alert('Please write something in your journal.'); return; }
        
        state.journals = state.journals.filter(j => j.date !== date);
        state.journals.unshift({ date, text, mood: state.selectedMood });
        saveData();
        renderJournalList();
        showSuccess('Journal entry saved!');
    }

    function loadJournalEntryForDate() {
        const date = $('#journalDate').value;
        const entry = state.journals.find(j => j.date === date);
        
        $('#journalText').value = entry ? entry.text : '';
        state.selectedMood = entry ? entry.mood : 3;
        
        $$('.mood-option').forEach(opt => {
            opt.classList.toggle('selected', Number(opt.dataset.mood) === state.selectedMood);
        });
    }

    function selectMood(e) {
        const target = e.target.closest('.mood-option');
        if (!target) return;
        state.selectedMood = Number(target.dataset.mood);
        $$('.mood-option').forEach(opt => opt.classList.remove('selected'));
        target.classList.add('selected');
    }
    
    function renderJournalList() {
        const list = $('#journalList');
        const moodMap = { 1: 'üò©', 2: 'üòê', 3: 'üôÇ', 4: 'üòä', 5: 'ü§©' };
        
        const recent = [...state.journals].sort((a,b) => b.date.localeCompare(a.date)).slice(0, 7);
        
        list.innerHTML = recent.length ? recent.map(j => `
            <li>
                <div style="flex:1">
                    <div style="font-weight: 600;">${fmt.formatDateDisplay(j.date)} ${moodMap[j.mood] || ''}</div>
                    <div class="muted">${j.text.slice(0, 100)}${j.text.length > 100 ? '...' : ''}</div>
                </div>
            </li>
        `).join('') : `<li style="opacity:1" class="muted">No recent journal entries.</li>`;
    }

    // --- INITIALIZATION ---
    function init() {
      applyTheme(state.theme);

      onAuthStateChanged(auth, async (user) => {
          // Hide loader once auth state is known
          $('#loader').classList.add('hidden');

          if (user) {
              // User is signed in
              document.body.classList.add('logged-in');
              state.user = user;
              await loadData();
              const hash = location.hash.replace('#', '');
              navigate(routes.some(r => r.id === hash) ? hash : 'dashboard');
          } else {
              // User is signed out
              document.body.classList.remove('logged-in');
              state.user = null;
              state.tasks = []; state.habits = []; state.journals = []; // Clear local state
              $('#tabs').innerHTML = ''; // Clear tabs
              mountAuth(); // Show the login screen
          }
      });
    }

    // Run the app
    init();

  </script>
</body>
</html>